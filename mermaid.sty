% mermaid.sty — минимальная интеграция Mermaid CLI в LaTeX
% версия 2025/11/05
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mermaid}[2025/11/05 Minimal Mermaid integration]

% параметры по умолчанию
\newif\ifmermaidpdf
\mermaidpdftrue
\def\mermaidcli{mmdc}          % путь к mermaid-cli
\def\mermaidoutdir{.mermaid}   % каталог для кэша (в обычном режиме)
\def\mermaidscale{1.0}         % масштаб
\def\mermaidbg{transparent}    % фон

% режим flat: писать файлы в текущий каталог (для систем с openout_any=p)
\newif\ifmermaidflat
\mermaidflatfalse

% опции
\DeclareOption{svg}{\mermaidpdffalse}
\DeclareOption{pdf}{\mermaidpdftrue}
\DeclareOption{flat}{\mermaidflattrue}
\ProcessOptions\relax

% нужные пакеты
\RequirePackage{graphicx}
\RequirePackage{ifthen}
\RequirePackage{xstring}
\RequirePackage{environ}  % для \NewEnviron
\RequirePackage{fancyvrb}  % для verbatim записи

% md5 (pdfTeX/LuaTeX/XeTeX)
\ifdefined\pdfmdfivesum
  \newcommand\mermaidhash[1]{\pdfmdfivesum{#1}}
\else
  \newcommand\mermaidhash[1]{\mdfivesum{#1}}
\fi

% Счетчик для уникальных имен файлов
\newcounter{mermaidcounter}

% mkdir для обычного (не flat) режима
\newcommand*\mermaidhmkdir{%
  \ifmermaidflat\relax\else
    \immediate\write18{mkdir -p \mermaidoutdir > /dev/null 2>&1}%
  \fi
}

% основная команда
\newcommand{\mermaid}[2][]{%
  \begingroup
  \mermaidhmkdir
  \edef\MMraw{#2}%
  \edef\MMhash{\mermaidhash{\MMraw}}%
  % базовое имя файлов (flat: mermaid-<hash>.*; иначе: <outdir>/<hash>.*)
  \ifmermaidflat
    \edef\MMbase{mermaid-\MMhash}%
  \else
    \edef\MMbase{\mermaidoutdir/\MMhash}%
  \fi
  \def\MMsrc{\MMbase.mmd}%
  \ifmermaidpdf
    \def\MMout{\MMbase.pdf}%
  \else
    \def\MMout{\MMbase.svg}%
  \fi
  % создаём исходник, если нет (TeX пишет только в текущий каталог при flat)
  \IfFileExists{\MMsrc}{}{%
    \newwrite\MMfile
    \immediate\openout\MMfile=\MMsrc
    \immediate\write\MMfile{#2}%
    \immediate\closeout\MMfile
  }%
  % генерируем выход через mmdc, если нет
  \IfFileExists{\MMout}{}{%
    \immediate\write18{%
      \mermaidcli\space
      -i \MMsrc\space
      -o \MMout\space
      -b \mermaidbg\space
      -s \mermaidscale
    }%
  }%
  % вставляем картинку
  \IfFileExists{\MMout}{%
    \includegraphics[#1]{\MMout}%
  }{%
    \fbox{\footnotesize Mermaid render failed: \MMout}%
  }%
  \endgroup
}

% окружение для многострочного Mermaid-кода (verbatim с сохранением переносов строк)
\newenvironment{mermaidenv}[1][]{%
  \stepcounter{mermaidcounter}%
  \mermaidhmkdir
  \ifmermaidflat
    \edef\MMbase{mermaid-\arabic{mermaidcounter}}%
  \else
    \edef\MMbase{\mermaidoutdir/\arabic{mermaidcounter}}%
  \fi
  \edef\MMsrc{\MMbase.mmd}%
  \ifmermaidpdf
    \edef\MMout{\MMbase.pdf}%
  \else
    \edef\MMout{\MMbase.svg}%
  \fi
  % сохраняем опции для использования после \endVerbatimOut
  \IfStrEq{#1}{}{%
    \gdef\mermaidopts{}%
  }{%
    \gdef\mermaidopts{[#1]}%
  }%
  % начинаем verbatim запись в файл
  \VerbatimOut{\MMsrc}%
}{%
  \endVerbatimOut
  % генерируем выход через mmdc
  \IfFileExists{\MMout}{}{%
    \immediate\write18{%
      \mermaidcli\space
      -i \MMsrc\space
      -o \MMout\space
      -b \mermaidbg\space
      -s \mermaidscale
    }%
  }%
  % вставляем картинку
  \IfFileExists{\MMout}{%
    \expandafter\includegraphics\mermaidopts{\MMout}%
  }{%
    \fbox{\footnotesize Mermaid render failed: \MMout}%
  }%
}
