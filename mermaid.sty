\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mermaid}[2025/01/05 Mermaid diagrams support]

% Package options
\newif\ifmermaid@pdf
\DeclareOption{pdf}{\mermaid@pdftrue}
\DeclareOption{svg}{\mermaid@pdffalse}
\ProcessOptions\relax

% Required packages
\RequirePackage{graphicx}
\RequirePackage{fancyvrb}

% Counter for unique file names
\newcounter{mermaid@counter}
\setcounter{mermaid@counter}{0}

% Directory for temporary Mermaid files
\def\mermaid@dir{mermaid-images}

% Create directory if it doesn't exist
\AtBeginDocument{%
  \immediate\write18{mkdir -p \mermaid@dir}%
}

% Helper to generate and include mermaid diagram
\newcommand{\mermaid@generate}[2]{%
  % #1 = width, #2 = mmd file path
  \edef\mermaid@mmdfile{#2}%
  \edef\mermaid@pdffile{#2.pdf}%
  \ifmermaid@pdf
    % Generate PDF only
    \immediate\write18{mmdc -i \mermaid@mmdfile\space -o \mermaid@pdffile\space -b transparent}%
  \else
    % Generate both SVG and PDF
    \edef\mermaid@svgfile{#2.svg}%
    \immediate\write18{mmdc -i \mermaid@mmdfile\space -o \mermaid@svgfile\space -b transparent && mmdc -i \mermaid@mmdfile\space -o \mermaid@pdffile\space -b transparent}%
  \fi
  % Always include as PDF (more compatible)
  \IfFileExists{\mermaid@pdffile}{%
    \includegraphics[width=#1]{\mermaid@pdffile}%
  }{%
    \fbox{\parbox[t]{#1}{\small\tt Error: Mermaid diagram generation failed}}%
  }%
}

% Write content to file via shell echo
\newcommand{\mermaid@writeviaShell}[2]{%
  % #1 = content, #2 = file path
  \immediate\write18{printf '\@percentchar s' "#1" > "#2"}%
}

% Command version: \mermaid[width]{code}
\newcommand{\mermaid}[2][\linewidth]{%
  \stepcounter{mermaid@counter}%
  \edef\mermaid@basename{mermaid-\themermaid@counter}%
  \edef\mermaid@mmdfile{\mermaid@dir/\mermaid@basename.mmd}%
  % Write content via shell
  \mermaid@writeviaShell{#2}{\mermaid@mmdfile}%
  \mermaid@generate{#1}{\mermaid@mmdfile}%
}

% Environment version using VerbatimOut
\newenvironment{mermaidenv}[1][\linewidth]{%
  \stepcounter{mermaid@counter}%
  \edef\mermaid@basename{mermaid-\themermaid@counter}%
  \edef\mermaid@mmdfile{\mermaid@dir/\mermaid@basename.mmd}%
  \xdef\mermaid@currentwidth{#1}%
  \xdef\mermaid@currentfile{\mermaid@mmdfile}%
  \VerbatimOut{\mermaid@mmdfile}%
}{%
  \endVerbatimOut
  \begin{center}%
    \mermaid@generate{\mermaid@currentwidth}{\mermaid@currentfile}%
  \end{center}%
}

\endinput
