% Объявляем, что пакет требует формат LaTeX2e
\NeedsTeXFormat{LaTeX2e}
% Предоставляем информацию о пакете (имя, дата, описание)
\ProvidesPackage{mermaid}[2025/01/05 Mermaid diagrams support]

% Подключаемые пакеты
% graphicx - для вставки изображений
\RequirePackage{graphicx}
% fancyvrb - для работы с verbatim окружениями (сохранение текста как есть)
\RequirePackage{fancyvrb}

% Счётчик для уникальных имён файлов
% Создаём счётчик для нумерации диаграм
\newcounter{mermaid@counter}

% Директория для временных файлов Mermaid
% Определяем имя папки для хранения .mmd и .png файлов
\def\mermaid@dir{mermaid-images}

% Создание директории при начале документа
% Хук, выполняемый в начале документа
\AtBeginDocument{%
  % Выполняем shell-команду для создания папки (если не существует)
  \immediate\write18{mkdir -p \mermaid@dir}%
}

% Вспомогательная функция для получения имени файла диаграммы
% Результат сохраняется в \mermaid@mmdfile
\newcommand{\mermaid@getfilename}{%
  % Увеличиваем счётчик диаграм на 1
  \stepcounter{mermaid@counter}%
  % Формируем базовое имя файла (mermaid-1, mermaid-2, ...)
  \edef\mermaid@basename{mermaid-\themermaid@counter}%
  % Формируем полный путь к .mmd файлу
  \edef\mermaid@mmdfile{\mermaid@dir/\mermaid@basename.mmd}%
}

% Вспомогательная функция для получения параметров Puppeteer
% Результат сохраняется в \mermaid@puppeteerconfig
\newcommand{\mermaid@getpuppeteerconfig}{%
  % Проверяем существование puppeteer-config.json для настроек Chromium
  \IfFileExists{puppeteer-config.json}{%
    % Если файл есть, добавляем параметр -p с путём к конфигу
    \def\mermaid@puppeteerconfig{-p puppeteer-config.json}%
  }{%
    % Если файла нет, параметр остаётся пустым
    \def\mermaid@puppeteerconfig{}%
  }%
}

% Вспомогательная команда для генерации и вставки диаграммы Mermaid
\newcommand{\mermaid@generate}[2]{%
  % #1 = опции для includegraphics (width, height, scale, keepaspectratio и т.д.), #2 = путь к .mmd файлу
  % Сохраняем путь к .mmd файлу в переменную
  \edef\mermaid@mmdfile{#2}%
  % Формируем путь к выходному PNG файлу
  \edef\mermaid@pngfile{#2.png}%
  % Получаем параметры конфигурации Puppeteer
  \mermaid@getpuppeteerconfig
  % Генерируем PNG файл через mmdc (Mermaid CLI)
  \immediate\write18{mmdc -i \mermaid@mmdfile\space -o \mermaid@pngfile\space -b transparent \mermaid@puppeteerconfig}%
  % Вставляем PNG файл в документ
  \IfFileExists{\mermaid@pngfile}{%
    % Если PNG файл существует, вставляем его с заданными опциями (или без опций для естественного размера)
    \includegraphics[#1]{\mermaid@pngfile}%
  }{%
    % Если генерация не удалась, показываем сообщение об ошибке
    \fbox{\parbox[t]{10cm}{\small\tt Error: Mermaid diagram generation failed}}%
  }%
}

% Запись содержимого в файл через shell
\newcommand{\mermaid@writeviaShell}[2]{%
  % #1 = содержимое, #2 = путь к файлу
  % Используем printf для записи содержимого в файл (сохраняет форматирование)
  \immediate\write18{printf '\@percentchar s' "#1" > "#2"}%
}

% Командная версия: \mermaid[опции]{код}
% По умолчанию использует естественный размер изображения
% Опции могут быть: width=5cm, height=3cm, scale=0.8, keepaspectratio и т.д.
\newcommand{\mermaid}[2][]{%
  % Получаем уникальное имя файла для диаграммы
  \mermaid@getfilename
  % Записываем код Mermaid в файл через shell
  \mermaid@writeviaShell{#2}{\mermaid@mmdfile}%
  % Генерируем и вставляем диаграмму
  \mermaid@generate{#1}{\mermaid@mmdfile}%
}

% Глобальная переменная для хранения опций окружения
\gdef\mermaid@includegraphics{}

% Окружение для многострочных диаграмм: \begin{mermaidenv}[опции]...\end{mermaidenv}
% По умолчанию использует естественный размер изображения
% Опции могут быть: width=\linewidth, width=5cm, height=3cm, scale=0.8 и т.д.
\newenvironment{mermaidenv}[1][]{%
  % Сохраняем опции в глобальную переменную (без расширения, graphicx сам обработает команды)
  \gdef\mermaid@includegraphics{#1}%
  % Получаем уникальное имя файла для диаграммы
  \mermaid@getfilename
  % Начинаем захват verbatim текста в файл (сохраняет все символы как есть, включая переносы строк)
  \VerbatimOut{\mermaid@mmdfile}%
}{%
  % Завершаем захват verbatim текста
  \endVerbatimOut
  % Генерируем и вставляем диаграмму с сохранёнными опциями
  % Используем \expandafter для расширения значения переменной перед передачей в функцию
  % Используем имя файла, полученное в первом блоке (сохранено в \mermaid@mmdfile)
  \expandafter\mermaid@generate\expandafter{\mermaid@includegraphics}{\mermaid@mmdfile}%
  % Сбрасываем опции после использования
  \gdef\mermaid@includegraphics{}%
}

% Конец файла пакета
\endinput
