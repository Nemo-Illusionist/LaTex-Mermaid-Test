name: Test Mermaid Package

on:
  push:
    branches: [ master, main ]
    paths:
      - 'mermaid-package/**'
      - '.github/workflows/test-package.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'mermaid-package/**'
      - '.github/workflows/test-package.yml'
  workflow_dispatch:  # Ручной запуск

jobs:
  test-package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache npm global packages
      uses: actions/cache@v4
      id: cache-npm-global
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-global-${{ hashFiles('.github/workflows/test-package.yml') }}
        restore-keys: |
          ${{ runner.os }}-npm-global-

    - name: Cache apt packages and installed binaries
      uses: actions/cache@v4
      id: cache-apt
      with:
        path: |
          /var/cache/apt/archives
          /usr/share/texlive
          /usr/lib/chromium
          /usr/lib/x86_64-linux-gnu/chromium
          /snap/chromium
        key: ${{ runner.os }}-apt-chromium-texlive-v2-${{ hashFiles('.github/workflows/test-package.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-chromium-texlive-v2-
          ${{ runner.os }}-apt-chromium-texlive-

    - name: Install Chromium dependencies
      run: |
        if ! command -v chromium-browser &> /dev/null && ! command -v chromium &> /dev/null; then
          echo "Installing Chromium and dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            chromium-browser \
            libgbm1 \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2t64
        else
          echo "Chromium already installed (from cache or system)"
          chromium-browser --version || chromium --version || echo "Chromium installed but version check failed"
        fi

    - name: Install Mermaid CLI
      run: |
        if ! command -v mmdc &> /dev/null; then
          echo "Installing Mermaid CLI..."
          npm install -g @mermaid-js/mermaid-cli
        else
          echo "Mermaid CLI already installed (from cache)"
        fi
        mmdc --version

    - name: Configure Puppeteer for mmdc
      run: |
        # Создать конфигурацию Puppeteer с --no-sandbox
        cat > puppeteer-config.json << 'EOF'
        {
          "args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]
        }
        EOF
        echo "Puppeteer config created:"
        cat puppeteer-config.json

    - name: Install TeX Live
      run: |
        if ! command -v xelatex &> /dev/null; then
          echo "Installing TeX Live..."
          sudo apt-get update
          sudo apt-get install -y \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-latex-extra \
            fonts-liberation \
            fonts-dejavu-core
        else
          echo "TeX Live already installed (from cache)"
          xelatex --version | head -2
        fi

    - name: Cleanup apt cache lock files
      run: |
        # Remove lock files and directories that cause permission issues during cache save
        sudo rm -f /var/cache/apt/archives/lock
        sudo rm -rf /var/cache/apt/archives/partial
        echo "Cleaned up apt cache lock files"

    - name: Run package tests
      run: |
        # Копируем puppeteer-config.json в mermaid-package для тестов
        cp puppeteer-config.json mermaid-package/
        cd mermaid-package
        chmod +x test-package.sh
        ./test-package.sh

    - name: Final cleanup for cache
      run: |
        # Final cleanup before cache save (lock files are recreated during apt-get install)
        sudo rm -f /var/cache/apt/archives/lock
        sudo rm -rf /var/cache/apt/archives/partial
        echo "Final cache cleanup done"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: package-test-results
        path: |
          mermaid-package/test-output/**
          mermaid-package/output/**
        retention-days: 7
