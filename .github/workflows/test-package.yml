name: Test Mermaid Package

on:
  push:
    branches: [ master, main ]
    paths:
      - 'mermaid-package/**'
      - '.github/workflows/test-package.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'mermaid-package/**'
      - '.github/workflows/test-package.yml'
  workflow_dispatch:  # Ручной запуск

jobs:
  test-package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache npm global packages
      uses: actions/cache@v4
      id: cache-npm-global
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-global-${{ hashFiles('.github/workflows/test-package.yml') }}
        restore-keys: |
          ${{ runner.os }}-npm-global-

    # Не кэшируем системные пакеты (apt/Chromium/TeX) - это создает проблемы с правами доступа
    # Оставляем только npm кэш, который работает надежно

    - name: Install Chromium dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          libgbm1 \
          libnss3 \
          libnspr4 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxfixes3 \
          libxrandr2 \
          libpango-1.0-0 \
          libcairo2 \
          libasound2t64

    - name: Install Mermaid CLI
      run: |
        if ! command -v mmdc &> /dev/null; then
          echo "Installing Mermaid CLI..."
          npm install -g @mermaid-js/mermaid-cli
        else
          echo "Mermaid CLI already installed (from cache)"
        fi
        mmdc --version

    - name: Configure Puppeteer for mmdc
      run: |
        # Создать конфигурацию Puppeteer с --no-sandbox
        cat > puppeteer-config.json << 'EOF'
        {
          "args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]
        }
        EOF
        echo "Puppeteer config created:"
        cat puppeteer-config.json

    - name: Install TeX Live
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-xetex \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-latex-extra \
          fonts-liberation \
          fonts-dejavu-core

    - name: Run package tests
      run: |
        # Копируем puppeteer-config.json в mermaid-package для тестов
        cp puppeteer-config.json mermaid-package/
        cd mermaid-package
        chmod +x test-package.sh
        ./test-package.sh

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: package-test-results
        path: |
          mermaid-package/test-output/**
          mermaid-package/output/**
        retention-days: 7
