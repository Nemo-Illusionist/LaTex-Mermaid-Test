name: Build LaTeX PDF with Mermaid

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Позволяет запускать вручную

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Chromium dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          libgbm1 \
          libnss3 \
          libnspr4 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxfixes3 \
          libxrandr2 \
          libpango-1.0-0 \
          libcairo2 \
          libasound2t64

    - name: Install Mermaid CLI
      run: |
        npm install -g @mermaid-js/mermaid-cli
        mmdc --version

    - name: Configure Puppeteer for mmdc
      run: |
        # Создать конфигурацию Puppeteer с --no-sandbox
        cat > puppeteer-config.json << 'EOF'
        {
          "args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]
        }
        EOF
        echo "Puppeteer config created:"
        cat puppeteer-config.json

    - name: Install TeX Live
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-xetex \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-latex-extra \
          texlive-lang-cyrillic \
          fonts-liberation \
          fonts-dejavu-core

    - name: Install additional fonts for Russian
      run: |
        sudo apt-get install -y \
          fonts-freefont-ttf \
          fonts-liberation2 \
          fonts-noto
        # Обновить кэш шрифтов
        fc-cache -fv

    - name: Check available fonts
      run: fc-list | grep -i "liberation\|dejavu\|noto" | head -20

    - name: Update main.tex to use available fonts
      run: |
        # Заменить Arial на Liberation Sans
        sed -i 's/\\setmainfont{Arial}/\\setmainfont{Liberation Sans}/g' main.tex
        # Заменить Courier New на Liberation Mono
        sed -i 's/\\setmonofont{Courier New}/\\setmonofont{Liberation Mono}/g' main.tex
        echo "Updated main.tex:"
        head -15 main.tex

    - name: Compile LaTeX document
      run: |
        # Первая компиляция
        xelatex -shell-escape -interaction=nonstopmode main.tex
        # Вторая компиляция для корректных ссылок
        xelatex -shell-escape -interaction=nonstopmode main.tex

    - name: Check generated files
      run: |
        echo "Main PDF:"
        ls -lh main.pdf
        echo ""
        echo "Mermaid images:"
        ls -lh mermaid-images/

    - name: Upload PDF artifact
      uses: actions/upload-artifact@v4
      with:
        name: main-pdf
        path: main.pdf
        retention-days: 30

    - name: Upload Mermaid SVG files
      uses: actions/upload-artifact@v4
      with:
        name: mermaid-svg-images
        path: mermaid-images/*.svg
        retention-days: 30

    - name: Upload Mermaid PDF files
      uses: actions/upload-artifact@v4
      with:
        name: mermaid-pdf-images
        path: mermaid-images/*.pdf
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          *.log
          *.aux
        retention-days: 7

  # Опциональный job для создания релиза при тегах
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download PDF artifact
      uses: actions/download-artifact@v4
      with:
        name: main-pdf

    - name: Download SVG artifacts
      uses: actions/download-artifact@v4
      with:
        name: mermaid-svg-images
        path: mermaid-svg/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          main.pdf
          mermaid-svg/*.svg
        body: |
          Автоматически сгенерированный релиз LaTeX документа с Mermaid диаграммами.

          ## Содержимое
          - `main.pdf` - основной документ
          - Mermaid диаграммы в формате SVG
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
