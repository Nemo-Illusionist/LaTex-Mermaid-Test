name: Build LaTeX PDF with Mermaid

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Позволяет запускать вручную

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Chromium dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          libgbm1 \
          libnss3 \
          libnspr4 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxfixes3 \
          libxrandr2 \
          libpango-1.0-0 \
          libcairo2 \
          libasound2t64

    - name: Install Mermaid CLI
      run: |
        npm install -g @mermaid-js/mermaid-cli
        mmdc --version

    - name: Configure Puppeteer for mmdc
      run: |
        # Создать конфигурацию Puppeteer с --no-sandbox
        cat > puppeteer-config.json << 'EOF'
        {
          "args": ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"]
        }
        EOF
        echo "Puppeteer config created:"
        cat puppeteer-config.json

    - name: Install TeX Live
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-xetex \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-latex-extra \
          texlive-lang-cyrillic \
          fonts-liberation \
          fonts-dejavu-core

    - name: Install additional fonts for Russian
      run: |
        sudo apt-get install -y \
          fonts-freefont-ttf \
          fonts-liberation2 \
          fonts-noto
        # Обновить кэш шрифтов
        fc-cache -fv

    - name: Check available fonts
      run: fc-list | grep -i "liberation\|dejavu\|noto" | head -20

    - name: Update main.tex to use available fonts
      run: |
        # Заменить все вхождения Arial на Liberation Sans
        sed -i 's/Arial/Liberation Sans/g' main.tex
        # Заменить Courier New на Liberation Mono (если есть)
        sed -i 's/Courier New/Liberation Mono/g' main.tex
        echo "Updated main.tex:"
        head -15 main.tex

    - name: Compile LaTeX document
      run: |
        # Используем build.sh скрипт (он уже делает двойную компиляцию)
        chmod +x build.sh
        ./build.sh

    - name: Check generated files
      run: |
        echo "Main PDF:"
        ls -lh main.pdf
        echo ""
        echo "Build directory:"
        ls -lh build/
        echo ""
        echo "Mermaid images:"
        ls -lh build/mermaid-images/ || echo "No mermaid images found"

    - name: Validate PDF
      run: |
        # Устанавливаем poppler-utils для pdfinfo
        sudo apt-get install -y poppler-utils

        # Проверяем что PDF валидный и содержит страницы
        echo "PDF Information:"
        pdfinfo main.pdf

        # Проверяем количество страниц
        PAGES=$(pdfinfo main.pdf | grep "Pages:" | awk '{print $2}')
        echo ""
        echo "Number of pages: $PAGES"

        if [ "$PAGES" -lt 1 ]; then
          echo "Error: PDF has no pages!"
          exit 1
        fi

        if [ "$PAGES" -gt 0 ]; then
          echo "✓ PDF is valid with $PAGES pages"
        fi

        # Проверяем размер файла (должен быть больше 1KB)
        SIZE=$(stat -c%s main.pdf)
        if [ "$SIZE" -lt 1024 ]; then
          echo "Error: PDF is too small ($SIZE bytes)"
          exit 1
        fi
        echo "✓ PDF size is $SIZE bytes"

    - name: Upload PDF artifact
      uses: actions/upload-artifact@v4
      with:
        name: main-pdf
        path: main.pdf
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/*.log
          build/*.aux
        retention-days: 7

  # Опциональный job для создания релиза при тегах
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download PDF artifact
      uses: actions/download-artifact@v4
      with:
        name: main-pdf

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          main.pdf
        body: |
          Автоматически сгенерированный релиз LaTeX документа с Mermaid диаграммами.

          ## Содержимое
          - `main.pdf` - основной документ
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
