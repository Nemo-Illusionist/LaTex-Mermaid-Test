#!/bin/bash
# Pre-commit hook для проверки безопасности .tex файлов
# Установка: ./setup-hooks.sh
# Или вручную: ln -s ../../git-hooks/pre-commit .git/hooks/pre-commit

set -e

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}🔍 Проверка безопасности .tex файлов...${NC}"

# Получить список файлов .tex, которые будут закоммичены
TEX_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.tex$' || true)

if [ -z "$TEX_FILES" ]; then
    echo -e "${GREEN}✓ Нет .tex файлов для проверки${NC}"
    exit 0
fi

# Проверить наличие скрипта валидации
VALIDATOR="scripts/validate-tex.sh"
if [ ! -f "$VALIDATOR" ]; then
    echo -e "${RED}✗ Не найден скрипт валидации: $VALIDATOR${NC}"
    echo -e "${YELLOW}  Коммит разрешён, но рекомендуется создать скрипт валидации${NC}"
    exit 0
fi

# Запустить валидацию для каждого .tex файла
VALIDATION_FAILED=0
for file in $TEX_FILES; do
    echo -e "  Проверка: $file"
    if ! "$VALIDATOR" "$file" > /dev/null 2>&1; then
        echo -e "${RED}✗ Проверка безопасности не пройдена: $file${NC}"
        echo -e "${YELLOW}  Запустите: $VALIDATOR $file для деталей${NC}"
        VALIDATION_FAILED=1
    fi
done

if [ $VALIDATION_FAILED -eq 1 ]; then
    echo -e "\n${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}⚠️  Коммит отклонён: обнаружены проблемы безопасности${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${YELLOW}Опции:${NC}"
    echo -e "  1. Исправьте проблемы в .tex файлах"
    echo -e "  2. Используйте --no-verify для пропуска проверки (НЕ РЕКОМЕНДУЕТСЯ)"
    echo -e ""
    exit 1
fi

echo -e "${GREEN}✓ Все .tex файлы прошли проверку безопасности${NC}"
exit 0
