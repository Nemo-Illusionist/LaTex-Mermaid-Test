% ==============================================================================
% Пакет mermaid.sty v1.0.0
% Автор: Модифицированная версия для интеграции Mermaid диаграмм в LaTeX
% Дата: 2025/01/05
%
% Описание:
%   Позволяет вставлять Mermaid диаграммы в LaTeX документы с автоматической
%   генерацией изображений через mermaid-cli (mmdc).
%
% Требования:
%   - XeLaTeX/LuaLaTeX с опцией --shell-escape
%   - Node.js и @mermaid-js/mermaid-cli (mmdc)
%
% Использование:
%   \usepackage{mermaid}                          % Дефолтные настройки
%   \usepackage[outputdir=out]{mermaid}           % Кастомная output-directory
%   \usepackage[mermaiddir=diagrams]{mermaid}     % Кастомная папка для диаграмм
%   \usepackage[outputdir=build, mermaiddir=img/mermaid]{mermaid}  % Оба параметра
%
% Примеры:
%   \mermaid[width=5cm]{graph TD; A-->B}          % Inline диаграмма
%   \begin{mermaidenv}[width=\linewidth]          % Multiline диаграмма
%     graph LR
%       A-->B
%   \end{mermaidenv}
% ==============================================================================

% Объявляем, что пакет требует формат LaTeX2e
\NeedsTeXFormat{LaTeX2e}
% Предоставляем информацию о пакете (имя, дата, версия, описание)
\ProvidesPackage{mermaid}[2025/01/05 v1.0.0 Mermaid diagrams support]

% Подключаемые пакеты
% graphicx - для вставки изображений
\RequirePackage{graphicx}
% fancyvrb - для работы с verbatim окружениями (сохранение текста как есть)
\RequirePackage{fancyvrb}
% kvoptions - для обработки опций пакета
\RequirePackage{kvoptions}

% Настройка опций пакета
\SetupKeyvalOptions{
  family=mermaid,
  prefix=mermaid@
}

% Опция для задания имени директории с mermaid файлами
% Использование: \usepackage[mermaiddir=diagrams]{mermaid}
\DeclareStringOption[mermaid-images]{mermaiddir}

% Опция для задания output-directory (если используется xelatex -output-directory)
% Использование: \usepackage[outputdir=out]{mermaid}
\DeclareStringOption[build]{outputdir}

% Опция для включения детального логирования ошибок mmdc
% Использование: \usepackage[verbose]{mermaid}
\DeclareBoolOption[false]{verbose}

% Обрабатываем опции
\ProcessKeyvalOptions*

% Информационные сообщения о конфигурации
\PackageInfo{mermaid}{v1.0.0 loaded}
\PackageInfo{mermaid}{Mermaid directory: \mermaid@mermaiddir}
\PackageInfo{mermaid}{Output directory: \mermaid@outputdir}

% Счётчик для уникальных имён файлов
% Создаём счётчик для нумерации диаграм
\newcounter{mermaid@counter}

% Директория для временных файлов Mermaid
% Используем значения из опций или дефолтные
% Пользователь может переопределить через \renewcommand{\mermaiddir}{...} ДО \usepackage{mermaid}
\providecommand{\mermaiddir}{\mermaid@mermaiddir}
\providecommand{\mermaidoutputdir}{\mermaid@outputdir}

% Внутренние переменные (для обратной совместимости)
\edef\mermaid@dir{\mermaiddir}
\edef\mermaid@outputdir{\mermaidoutputdir}

% ====== Проверка зависимостей ======

% Флаг доступности mmdc
\newif\ifmermaid@mmdc@available
\mermaid@mmdc@availabletrue

% Проверка наличия mmdc при загрузке пакета
\AtBeginDocument{%
  % Проверяем наличие mmdc
  \immediate\write18{command -v mmdc > /dev/null 2>\&1 || echo "MMDC_NOT_FOUND" > \mermaid@outputdir/mermaid-check.tmp || echo "MMDC_NOT_FOUND" > mermaid-check.tmp}%

  % Проверяем результат
  \IfFileExists{\mermaid@outputdir/mermaid-check.tmp}{%
    \PackageWarning{mermaid}{mmdc (Mermaid CLI) not found! Please install: npm install -g @mermaid-js/mermaid-cli}%
    \mermaid@mmdc@availablefalse
  }{%
    \IfFileExists{mermaid-check.tmp}{%
      \PackageWarning{mermaid}{mmdc (Mermaid CLI) not found! Please install: npm install -g @mermaid-js/mermaid-cli}%
      \mermaid@mmdc@availablefalse
    }{%
      \PackageInfo{mermaid}{mmdc found and ready to use}%
    }%
  }%

  % Создаём mermaid-images внутри output-directory, если она существует
  \immediate\write18{if [ -d "\mermaid@outputdir" ]; then mkdir -p "\mermaid@outputdir/\mermaid@dir" && ln -sf "\mermaid@outputdir/\mermaid@dir" "\mermaid@dir"; else mkdir -p "\mermaid@dir"; fi}%
}

% Вспомогательная функция для получения имени файла диаграммы
% Результат сохраняется в \mermaid@mmdfile
\newcommand{\mermaid@getfilename}{%
  % Увеличиваем счётчик диаграм на 1
  \stepcounter{mermaid@counter}%
  % Формируем базовое имя файла (mermaid-1, mermaid-2, ...)
  \edef\mermaid@basename{mermaid-\themermaid@counter}%
  % Формируем путь к .mmd файлу (для VerbatimOut)
  % Если используется output-directory, файлы будут в build/mermaid-images
  \edef\mermaid@mmdfile{\mermaid@dir/\mermaid@basename.mmd}%
}

% Вспомогательная функция для получения параметров Puppeteer
% Результат сохраняется в \mermaid@puppeteerconfig
\newcommand{\mermaid@getpuppeteerconfig}{%
  % Проверяем существование puppeteer-config.json для настроек Chromium
  \IfFileExists{puppeteer-config.json}{%
    % Если файл есть, добавляем параметр -p с путём к конфигу
    \def\mermaid@puppeteerconfig{-p puppeteer-config.json}%
  }{%
    % Если файла нет, параметр остаётся пустым
    \def\mermaid@puppeteerconfig{}%
  }%
}

% Вспомогательная команда для генерации и вставки диаграммы Mermaid
\newcommand{\mermaid@generate}[2]{%
  % #1 = опции для includegraphics (width, height, scale, keepaspectratio и т.д.), #2 = путь к .mmd файлу
  % Сохраняем путь к .mmd файлу в переменную (относительный для includegraphics)
  \edef\mermaid@mmdfile{#2}%
  % Формируем путь к выходному PNG файлу (относительный)
  \edef\mermaid@pngfile{#2.png}%
  % Формируем путь к лог-файлу для ошибок mmdc
  \edef\mermaid@logfile{#2.log}%

  % Проверяем доступность mmdc
  \ifmermaid@mmdc@available
    % Формируем абсолютные пути для shell команд
    % Если используется output-directory, файлы находятся в build/mermaid-images
    \edef\mermaid@absmmdfile{$(pwd)/\mermaid@outputdir/#2}%
    \edef\mermaid@abspngfile{$(pwd)/\mermaid@outputdir/#2.png}%
    \edef\mermaid@abslogfile{$(pwd)/\mermaid@outputdir/#2.log}%
    % Получаем параметры конфигурации Puppeteer
    \mermaid@getpuppeteerconfig

    % Генерируем PNG файл через mmdc (Mermaid CLI) с абсолютными путями
    \ifmermaid@verbose
      % С verbose: логируем stderr в .log файл для диагностики
      \PackageInfo{mermaid}{Generating diagram with verbose logging: #2}%
      \immediate\write18{if [ -f "\mermaid@absmmdfile" ]; then mmdc -i "\mermaid@absmmdfile" -o "\mermaid@abspngfile" -b transparent \mermaid@puppeteerconfig 2> "\mermaid@abslogfile" || echo "mmdc failed" >> "\mermaid@abslogfile"; else mmdc -i "$(pwd)/#2" -o "$(pwd)/#2.png" -b transparent \mermaid@puppeteerconfig 2> "$(pwd)/#2.log" || echo "mmdc failed" >> "$(pwd)/#2.log"; fi}%
    \else
      % Без verbose: только генерация без логирования
      \PackageInfo{mermaid}{Generating diagram: #2}%
      \immediate\write18{if [ -f "\mermaid@absmmdfile" ]; then mmdc -i "\mermaid@absmmdfile" -o "\mermaid@abspngfile" -b transparent \mermaid@puppeteerconfig; else mmdc -i "$(pwd)/#2" -o "$(pwd)/#2.png" -b transparent \mermaid@puppeteerconfig; fi}%
    \fi

    % Вставляем PNG файл в документ (используем относительный путь)
    \IfFileExists{\mermaid@pngfile}{%
      % PNG файл успешно создан
      \includegraphics[#1]{\mermaid@pngfile}%
    }{%
      % Если генерация не удалась, показываем детальное сообщение об ошибке
      \PackageError{mermaid}{Failed to generate diagram: #2}{Check \mermaid@logfile\space for details}%
      \fbox{\parbox[t]{10cm}{%
        \small\ttfamily
        \textbf{Mermaid Error:} Failed to generate diagram\\
        File: #2\\
        Check log: \mermaid@logfile%
      }}%
    }%
  \else
    % mmdc недоступен - показываем предупреждение
    \PackageWarning{mermaid}{Cannot generate diagram #2: mmdc not available}%
    \fbox{\parbox[t]{10cm}{%
      \small\ttfamily
      \textbf{Mermaid Error:} mmdc not found\\
      Install: npm install -g @mermaid-js/mermaid-cli%
    }}%
  \fi
}

% Запись содержимого в файл через shell
\newcommand{\mermaid@writeviaShell}[2]{%
  % #1 = содержимое, #2 = путь к файлу (относительный)
  % Формируем абсолютный путь для shell команд
  % Если используется output-directory, записываем в build/
  \edef\mermaid@tempabsfile{$(pwd)/\mermaid@outputdir/#2}%
  % Используем printf для записи содержимого в файл (сохраняет форматирование)
  % Используем fallback для случая без output-directory
  \immediate\write18{if [ -d "\mermaid@outputdir/\mermaid@dir" ]; then printf '\@percentchar s' "#1" > "\mermaid@tempabsfile"; else printf '\@percentchar s' "#1" > "$(pwd)/#2"; fi}%
}

% Командная версия: \mermaid[опции]{код}
% По умолчанию использует естественный размер изображения
% Опции могут быть: width=5cm, height=3cm, scale=0.8, keepaspectratio и т.д.
\newcommand{\mermaid}[2][]{%
  % Получаем уникальное имя файла для диаграммы
  \mermaid@getfilename
  % Записываем код Mermaid в файл через shell
  \mermaid@writeviaShell{#2}{\mermaid@mmdfile}%
  % Генерируем и вставляем диаграмму
  \mermaid@generate{#1}{\mermaid@mmdfile}%
}

% Глобальная переменная для хранения опций окружения
\gdef\mermaid@includegraphics{}

% Окружение для многострочных диаграмм: \begin{mermaidenv}[опции]...\end{mermaidenv}
% По умолчанию использует естественный размер изображения
% Опции могут быть: width=\linewidth, width=5cm, height=3cm, scale=0.8 и т.д.
\newenvironment{mermaidenv}[1][]{%
  % Сохраняем опции в глобальную переменную (без расширения, graphicx сам обработает команды)
  \gdef\mermaid@includegraphics{#1}%
  % Получаем уникальное имя файла для диаграммы
  \mermaid@getfilename
  % Начинаем захват verbatim текста в файл (сохраняет все символы как есть, включая переносы строк)
  \VerbatimOut{\mermaid@mmdfile}%
}{%
  % Завершаем захват verbatim текста
  \endVerbatimOut
  % Генерируем и вставляем диаграмму с сохранёнными опциями
  % Используем \expandafter для расширения значения переменной перед передачей в функцию
  % Используем имя файла, полученное в первом блоке (сохранено в \mermaid@mmdfile)
  \expandafter\mermaid@generate\expandafter{\mermaid@includegraphics}{\mermaid@mmdfile}%
  % Сбрасываем опции после использования
  \gdef\mermaid@includegraphics{}%
}

% Конец файла пакета
\endinput
